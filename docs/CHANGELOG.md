# SaltGoat 更新日志

## [0.8.1] - 2025-10-22

### 🔧 **权限管理优化**
- **修复权限问题**：解决 `valkey-renew` 脚本中的权限问题
- **env.php 权限**：从 `660` 改为 `644`，确保 Magento CLI 可读取
- **generated 目录**：在 `valkey-renew` 中删除重建，确保权限正确
- **权限修复策略**：区分保守修复（permissions fix）和激进修复（valkey-renew）

### 🆕 **新增功能**
- **OpenSearch 认证配置**：新增 `saltgoat magetools opensearch <user>` 命令
- **一键配置**：自动安装 apache2-utils，创建密码文件，配置 Nginx 认证
- **智能命名**：用户名 + 2010 作为密码，端口 9210，配置文件自动命名

### 🐛 **Bug 修复**
- **Nginx 配置**：修复主配置文件缺少 `include /etc/nginx/sites-enabled/*;` 的问题
- **站点清理**：清理 sites-enabled 目录中的备份文件
- **权限脚本**：修复所有脚本中的 sudo 权限问题

### 📚 **文档更新**
- **权限管理指南**：更新 `docs/MAGENTO_PERMISSIONS.md` 中的权限设置
- **帮助信息**：添加 OpenSearch 认证管理到帮助菜单
- **最佳实践**：统一所有脚本的权限管理最佳实践提示

### 🧹 **代码清理**
- **移除 emoji**：将所有 emoji 图标替换为统一的日志格式
- **统一格式**：使用 `[INFO]` `[SUCCESS]` `[WARNING]` `[ERROR]` 格式

## [0.8.0] - 2025-10-22

### 🎯 **重大改进**
- **项目结构优化**
  - 创建 `docs/` 目录，统一管理文档文件
  - 创建 `tests/` 目录，统一管理测试文件
  - 清理根目录，提高项目可维护性

- **权限管理最佳实践**
  - 新增 `docs/MAGENTO_PERMISSIONS.md` 权限管理指南
  - 修复权限管理函数，支持路径参数
  - 更新帮助信息，添加最佳实践提示

### 🔧 **功能改进**
- **权限管理命令优化**
  - `permissions check [path]` - 支持指定路径检查
  - `permissions fix [path]` - 支持指定路径修复
  - `permissions reset [path]` - 支持指定路径重置
  - 所有权限命令都使用 `sudo -u www-data` 最佳实践

- **脚本权限修复**
  - 修复 `valkey-renew.sh` 中的 sudo 权限问题
  - 修复 `migrate-detect.sh` 中的 sudo 权限问题
  - 移除不必要的 sudo 调用，避免权限混乱

### 📚 **文档更新**
- **新增文档**
  - `docs/MAGENTO_PERMISSIONS.md` - Magento 2 权限管理完整指南
  - 包含最佳实践、故障排除、安全建议

- **帮助信息优化**
  - 更新权限管理帮助信息
  - 添加路径参数说明
  - 添加最佳实践提示

### 🧹 **代码清理**
- **移除临时文件**
  - 删除 `alertmanager-0.26.0.linux-amd64*` 临时下载文件
  - 清理根目录，保持项目整洁

- **文件组织**
  - 文档文件统一移至 `docs/` 目录
  - 测试文件统一移至 `tests/` 目录
  - 提高项目结构的可维护性

## [0.7.1] - 2025-10-22

### 新增功能
- **Valkey 自动续期功能** (`saltgoat magetools valkey-renew`)
  - 随机分配数据库编号（10-99范围），避免冲突
  - 自动获取 Valkey 密码并清空指定数据库
  - 支持 `--restart-valkey` 参数重启 Valkey 服务
  - 完整的 Magento 缓存清理和重新编译流程

### 改进
- **统一日志格式**
  - 移除所有 emoji 图标
  - 使用统一的 `[INFO]` `[SUCCESS]` `[WARNING]` `[ERROR]` `[HIGHLIGHT]` 格式
  - 加载项目的 `lib/logger.sh` 库

- **Magento 工具集优化**
  - 清理 magetools 菜单，只保留核心功能
  - 移除简单的功能（cache、index、deploy、backup、performance、security、update等）
  - 保留：工具安装、权限管理、站点转换、Valkey缓存管理

- **Valkey 配置优化**
  - 支持 100 个数据库（0-99 范围）
  - 更新安装脚本和 systemd 服务配置

### 修复
- **权限问题修复**
  - 使用 `sudo` 执行文件备份和修改操作
  - 修复 `Permission denied` 错误

- **Valkey 认证问题修复**
  - 添加密码获取逻辑
  - 修复 `NOAUTH Authentication required` 错误
  - 确保数据库清空功能正常工作

- **数据库编号范围问题修复**
  - 修复数据库编号超出范围的问题
  - 确保随机分配的数据库编号在有效范围内

### 文档更新
- 更新帮助菜单，添加 `valkey-renew` 命令说明
- 更新示例命令和使用方法
- 完善 magetools 功能说明

## [0.6.1] - 2025-10-21

### 新增功能
- **Magento工具集** (`saltgoat magetools`)
  - 添加N98 Magerun2安装和管理
  - 添加N98 Magerun (Magento 1)支持
  - 添加Magento Cloud CLI支持
  - 添加PHPUnit单元测试框架安装
  - 添加Xdebug调试工具安装
  - 智能PHP扩展检测和自动安装
  - 完整的缓存管理功能
  - 索引管理功能
  - 部署管理功能
  - 备份恢复功能
  - 性能分析功能
  - 安全扫描功能
  - 更新管理功能

### 改进
- 优化工具安装流程，自动检测依赖
- 增强PHPUnit安装，自动处理PHP扩展
- 完善帮助系统和文档

### 修复
- 修复PHPUnit安装时的扩展依赖问题
- 优化工具版本检测逻辑

## [0.6.0] - 2025-01-21

### 🔧 重要修复
- **Nginx状态检测修复**: 修复了源码编译Nginx显示为inactive的问题，现在能正确识别手动启动的Nginx进程
- **optimize命令语法错误修复**: 修复了内存使用率解析失败的问题，现在optimize命令正常工作
- **automation模块basename错误修复**: 修复了Salt YAML输出解析导致的basename参数错误
- **env status命令添加**: 新增`saltgoat env status`命令，完善环境配置管理

### 🆕 新功能
- **每日更新检测**: 新增`daily-update-check`自动化任务，每天上午8点自动检测系统更新
- **智能更新通知**: 更新检测脚本支持邮件通知和详细日志记录
- **模块化文档**: 为所有8个模块创建了完整的README文档
- **Help菜单完善**: 更新了主help菜单，添加了遗漏的功能分类

### 📚 文档完善
- **模块README**: 为diagnose、profile、version-lock、monitoring、maintenance、optimization、security、automation模块创建了详细文档
- **功能说明**: 每个模块都包含使用方法、示例、配置说明和注意事项
- **交叉引用**: 模块间功能的相关引用和链接

### 🔍 测试覆盖
- **全面命令测试**: 测试了26个主要命令，96.2%的命令正常工作
- **问题修复验证**: 验证了所有修复的功能都正常工作
- **自动化任务测试**: 测试了新增的每日更新检测功能

### 🎯 技术改进
- **状态检测优化**: 改进了服务状态检测逻辑，支持systemd和手动启动两种方式
- **错误处理增强**: 改进了Salt命令调用的错误处理和输出解析
- **代码质量提升**: 修复了ShellCheck警告，提高了代码质量

## [0.5.7] - 2025-01-21

### 🚨 故障诊断功能
- **智能诊断系统**: 新增 `saltgoat diagnose` 命令，支持nginx、mysql、php、system、network诊断
- **问题检测**: 自动检测服务状态、配置错误、端口冲突、权限问题等
- **修复建议**: 为每个发现的问题提供具体的修复建议和命令
- **完整诊断**: 支持 `saltgoat diagnose all` 进行完整系统诊断

### 🔒 版本锁定功能
- **核心软件锁定**: 新增 `saltgoat version-lock` 命令，锁定核心LEMP软件版本
- **智能锁定策略**: 锁定Nginx、Percona、PHP、RabbitMQ、OpenSearch、Valkey、Varnish、Composer
- **安全更新**: 允许系统内核和安全补丁正常更新
- **版本管理**: 支持锁定、解锁、查看锁定状态等操作

### 🔧 技术改进
- **诊断模块**: 完善的服务状态检查和配置验证
- **版本控制**: 使用apt-mark进行软件包版本锁定
- **智能建议**: 根据锁定状态提供不同的更新建议
- **配置管理**: 自动创建版本锁定配置文件

### 🐛 错误修复
- 修复PHP扩展检查中的包名匹配问题
- 修复诊断摘要显示格式问题
- 完善版本状态检查的准确性

## [0.5.6] - 2025-01-21

### 🐛 错误修复
- **修复help功能**: 修复主脚本中缺少`lib/help.sh`加载的问题
- **完善帮助系统**: 确保所有22个功能的帮助信息都能正常显示
- **功能验证**: 验证help、status等基础功能的完整性

### 🔧 技术改进
- **库文件加载**: 完善主脚本的库文件加载顺序
- **错误处理**: 改进脚本的错误处理和调试信息
- **功能测试**: 增强功能测试和验证机制

## [0.5.5] - 2025-01-21

### 🎯 SaltGUI集成完善
- **官方样板配置**: 采用SaltGUI官方推荐的Nginx配置模板
- **API路径优化**: 使用`/api/`路径代理Salt API，符合官方最佳实践
- **会话管理**: 完善SaltGUI的登录和会话管理功能
- **一致性保证**: 确保git clone后安装的配置完全一致

### 🔧 技术改进
- **Nginx配置**: 使用官方样板，简化配置结构
- **API代理**: 优化Salt API的代理配置
- **配置模板**: 自动配置SaltGUI的API_URL设置
- **服务管理**: 完善Salt Master和Salt API的配置

### 🐛 错误修复
- 修复SaltGUI登录后的会话管理问题
- 修复Salt API的netapi_enable_clients配置
- 修复Nginx配置中的location规则冲突
- 完善SaltGUI的安装脚本一致性

## [0.5.4] - 2025-01-21

### 📧 邮件配置功能增强
- **新增reload-env命令**: 添加 `saltgoat system reload-env` 命令，支持重新加载环境变量
- **自动Postfix配置**: 环境变量更新后自动重新配置Postfix SMTP设置
- **邮件配置诊断**: 显示当前邮件配置状态，便于问题排查
- **TLS安全增强**: 改进SMTP TLS配置，支持Microsoft 365和Gmail等主流邮件服务商

### 🔧 系统管理改进
- **环境变量管理**: 支持通过 `.env` 文件管理邮件配置
- **配置一致性**: 确保Postfix配置与环境变量保持同步
- **错误处理**: 改进邮件配置错误处理和诊断信息

### 🐛 错误修复
- 修复Postfix relayhost配置格式问题
- 修复邮件被当作本地邮件处理的问题
- 改进SMTP认证配置，支持多种邮件服务商

## [0.5.3] - 2025-01-21

### 📧 邮件配置一致性改进
- **跨服务器一致性**: 修复邮件配置硬编码问题，支持环境变量和Salt Pillar管理
- **环境变量支持**: 添加SMTP_HOST、SMTP_USER、SMTP_PASSWORD等环境变量
- **Salt Pillar集成**: 邮件配置通过Salt Pillar动态管理，确保配置一致性
- **多服务商支持**: 支持Gmail、Microsoft 365等主流邮件服务商
- **可选安装**: Postfix和邮件功能作为可选组件，不强制要求

### 🔧 配置改进
- **Postfix配置**: 使用Salt模板和Pillar数据，自动适应不同服务器环境
- **SASL认证**: 动态配置SMTP认证，支持TLS加密传输
- **Grafana集成**: 邮件通知配置支持环境变量，提升易用性
- **安装指南**: 更新INSTALL.md，添加邮件配置说明

### 🐛 错误修复
- 修复邮件配置硬编码问题
- 改进Postfix配置模板，支持条件配置
- 优化Grafana邮件配置功能，支持环境变量

## [0.5.2] - 2025-01-21

### 🔧 配置一致性改进
- **跨服务器一致性**: 修复硬编码路径问题，确保在不同服务器上安装后配置完全一致
- **动态路径检测**: 改进SaltGoat版本检测，支持任意安装路径
- **Salt Grain配置**: 添加动态项目目录设置，支持灵活的安装位置
- **安装指南**: 新增详细的跨服务器安装指南 (INSTALL.md)

### 🐛 错误修复
- 修复consistency-test.sh中硬编码 `/home/doge/saltgoat` 路径的问题
- 修复mysql.sls中硬编码pillar路径的问题
- 改进路径检测逻辑，支持系统安装和源码安装两种模式

### 📚 文档改进
- **新增INSTALL.md**: 详细的跨服务器安装指南
- **一致性测试**: 完善配置一致性验证机制
- **安装流程**: 标准化安装流程，确保一致性

## [0.5.1] - 2025-01-21

### 🔧 监控系统改进
- **自动依赖安装**: Prometheus安装时自动安装Node Exporter和Nginx Exporter
- **Nginx监控修复**: 修复Nginx Exporter安装和配置问题
- **端口检测修复**: 修复监控集成脚本中的端口检测逻辑
- **业务场景检测**: 优化智能监控的业务场景检测显示

### 🐛 错误修复
- 修复Prometheus端口检测使用netstat而非ss的问题
- 修复Nginx Exporter需要status模块的配置问题
- 修复智能监控检测结果显示格式问题
- 修复监控集成脚本中日志函数调用问题

### 📊 监控功能增强
- **完整监控链路**: Prometheus + Grafana + Node Exporter + Nginx Exporter
- **自动配置**: 监控组件自动安装和配置
- **状态检查**: 实时监控所有组件的运行状态
- **防火墙管理**: 自动配置监控端口防火墙规则

## [0.5.0] - 2025-01-21

### 🚀 重大功能更新
- **监控集成系统**: 新增完整的Prometheus和Grafana监控集成
- **防火墙自动配置**: 智能检测并配置UFW、Firewalld、iptables防火墙
- **状态管理系统**: 新增Salt状态管理功能，支持状态列表、应用和回滚
- **代码质量工具**: 集成shellcheck代码检查和shfmt代码格式化

### 🔧 监控集成功能
- **Prometheus集成**: `saltgoat monitoring prometheus` - 自动安装配置Prometheus
- **Grafana集成**: `saltgoat monitoring grafana` - 自动安装配置Grafana仪表板
- **Node Exporter**: 自动安装系统监控组件
- **智能端口配置**: 自动放行9090、3000、9100端口
- **IPv4地址显示**: 显示实际服务器IP而非localhost

### 🛡️ 防火墙管理
- **多防火墙支持**: 自动检测UFW、Firewalld、iptables
- **智能端口放行**: 自动配置监控服务端口
- **防火墙状态检查**: 实时检查端口放行状态
- **跨平台兼容**: 支持Ubuntu、CentOS、Debian等发行版

### 📊 状态管理
- **状态列表**: `saltgoat state list` - 查看所有可用状态
- **状态应用**: `saltgoat state apply <name>` - 应用特定状态
- **状态回滚**: `saltgoat state rollback <name>` - 回滚到之前状态
- **自动备份**: 应用状态前自动创建备份
- **状态检查**: 显示服务状态和配置文件状态

### 🔍 代码质量
- **代码检查**: `saltgoat lint [file]` - 使用shellcheck检查代码
- **代码格式化**: `saltgoat format [file]` - 使用shfmt格式化代码
- **安全扫描**: `saltgoat security-scan` - 完整的安全扫描分析

### 🎯 用户体验提升
- **智能帮助系统**: 新增监控集成帮助页面
- **配置一致性**: 增强跨服务器配置一致性
- **IPv4地址显示**: 所有访问地址显示实际IP
- **防火墙状态**: 实时显示防火墙配置状态

### 📋 技术改进
- **模块化设计**: 监控集成功能独立模块化
- **错误处理**: 增强错误处理和调试信息
- **路径检测**: 改进配置文件路径自动检测
- **服务检测**: 优化服务状态检测逻辑

### 🎉 新增访问地址
- **Prometheus**: http://your-server-ip:9090
- **Grafana**: http://your-server-ip:3000 (admin/admin)
- **Node Exporter**: http://your-server-ip:9100/metrics

### 📊 推荐仪表板
- Node Exporter: 1860
- Nginx: 12559
- MySQL: 7362
- Valkey: 11835

## [0.4.4] - 2025-01-21

### 🐛 重要修复
- **Nginx配置语法错误修复**: 修复了`optimize magento`功能中Nginx `gzip_types`指令的语法错误
- **智能配置检测**: 改进了对不完整Nginx配置的检测和修复逻辑
- **配置一致性增强**: 确保在不同Nginx安装环境下都能正确处理配置

### 🔧 技术改进
- **智能gzip_types处理**: 自动检测`gzip_types`是否完整，并智能修复不完整的配置
- **错误恢复机制**: 增强了配置备份和恢复功能
- **sed命令优化**: 改进了多行配置的处理逻辑，避免语法错误

### 📋 修复详情
- 修复了`nginx: [emerg] unknown directive "text/plain"`错误
- 修复了`gzip_types`指令被错误分割的问题
- 改进了配置检测逻辑，支持各种Nginx配置格式
- 增强了错误处理和调试信息

### 🎯 用户体验
- **更稳定的优化**: `saltgoat optimize magento`现在更加稳定可靠
- **更好的错误处理**: 提供更清晰的错误信息和恢复建议
- **跨平台兼容**: 支持各种Nginx安装方式和配置格式

## [0.4.3] - 2025-01-21

### 🚀 重大改进
- **Magento优化配置一致性**: 大幅改进了`optimize magento`功能的跨平台兼容性
- **自动路径检测**: 支持多种Nginx和PHP安装路径的自动检测
- **灵活配置匹配**: 使用正则表达式匹配各种配置值格式，适应不同系统环境

### 🔧 功能增强
- **Nginx配置优化**: 自动检测配置文件路径（支持`/usr/local/nginx/conf/nginx.conf`和`/etc/nginx/nginx.conf`）
- **PHP版本自动检测**: 支持PHP 8.3, 8.2, 8.1, 8.0, 7.4的自动检测和配置
- **服务名称自动识别**: 自动检测PHP-FPM服务名称和可执行文件路径
- **错误处理改进**: 提供更清晰的错误信息和调试输出

### 📋 用户体验提升
- **透明化操作**: 显示检测到的配置文件路径和服务信息
- **调试信息**: 提供详细的系统检测和配置过程信息
- **一致性保证**: 确保在不同服务器上获得相同的优化效果

### 🛠️ 技术改进
- 使用动态路径检测替代硬编码路径
- 改进的配置匹配算法，支持多种格式
- 增强的错误处理和用户反馈机制
- 更好的跨平台兼容性

## [0.4.2] - 2025-01-21

### 🔧 修复和改进
- **磁盘监控修复**: 修复了`du`命令在Salt调用中的参数解析问题，现在可以正确显示目录大小统计
- **SSL证书生成优化**: 改进了证书生成函数的错误处理和权限检查，提高稳定性
- **监控PID显示修复**: 修复了服务监控中PID获取和显示逻辑，现在可以正确显示进程信息
- **系统维护功能优化**: 将系统更新检查改为直接使用`apt`命令，避免Salt超时问题

### 🐛 错误修复
- 修复了磁盘监控中`du: invalid option -- 'r'`和`du: invalid option -- '1'`错误
- 修复了SSL证书生成时的权限和错误处理问题
- 修复了监控功能中`error: list of process IDs must follow -p`错误
- 修复了系统更新检查超时问题

### 📦 技术改进
- 将部分Salt调用改为直接系统命令，提高性能和稳定性
- 优化了错误处理机制，提供更好的用户体验
- 改进了命令参数解析，避免Shell解析问题

---

## [0.4.1] - 2025-10-21

### 🔧 修复和改进
- **templates文件夹**: 重新创建了templates文件夹，用于存放自动化任务模板
- **文档完善**: 添加了templates文件夹的详细说明文档
- **功能验证**: 确认templates功能正常工作

### 📦 新增内容
- templates/README.md - 模板文件说明文档
- 支持自动化任务模板管理
- 完善的项目结构

### 🐛 错误修复
- 修复了templates文件夹被误删的问题
- 确保所有功能模块完整

---

## [0.4.0] - 2025-10-20

### 🚀 主要更新
- **性能优化**: 大幅提升SaltGoat运行速度，减少Salt调用次数
- **警告消除**: 修复了所有Salt警告和DeprecationWarning消息
- **用户体验**: 改进了命令输出格式和错误处理

### 🔧 修复和改进
- **状态检查**: 使用`systemctl`直接检查服务状态，避免Salt调用
- **数据库管理**: 优化MySQL数据库操作，使用直接命令替代Salt模块
- **服务管理**: 改进服务重启、启动、停止等操作
- **日志权限**: 修复Salt日志权限问题

### 📦 新增内容
- 支持Percona Server 8.4优化配置
- 改进的MySQL状态检查功能
- 优化的Valkey密码管理
- 完善的错误处理机制

### 🐛 错误修复
- 修复了Salt日志权限警告
- 修复了MySQL插件加载问题
- 修复了Valkey认证问题
- 修复了服务管理中的Salt警告

---

## [0.3.0] - 2025-10-19

### 🚀 主要更新
- **Web服务器**: 完整的Nginx 1.29.1 + ModSecurity v3编译安装
- **安全测试**: 全面的ModSecurity攻击测试和模拟器
- **Salt状态**: 完整的Salt状态文件管理

### 🔧 新增功能
- Nginx 1.29.1源码编译安装
- ModSecurity v3集成
- OWASP Core Rule Set (CRS)支持
- 完整的Web服务器Salt状态文件
- ModSecurity攻击测试脚本
- 安全威胁模拟器

### 📦 技术改进
- 支持动态模块加载
- 完整的SSL/TLS配置
- 优化的Nginx配置模板
- 系统服务管理

---

## [0.2.0] - 2025-10-18

### 🚀 主要更新
- **数据库管理**: 完整的MySQL/Percona支持
- **缓存系统**: Valkey (Redis兼容)集成
- **搜索引擎**: OpenSearch支持
- **消息队列**: RabbitMQ集成

### 🔧 新增功能
- MySQL/Percona数据库管理
- Valkey缓存系统
- OpenSearch搜索引擎
- RabbitMQ消息队列
- 数据库备份和恢复
- 性能监控

### 📦 技术改进
- 优化的数据库配置
- 完整的服务管理
- 监控和日志系统
- 自动化部署

---

## [0.1.0] - 2025-10-17

### 🚀 初始版本
- **基础框架**: SaltGoat核心功能
- **服务管理**: Nginx、PHP-FPM基础支持
- **Salt集成**: 完整的Salt状态管理
- **用户界面**: 命令行工具

### 🔧 核心功能
- Salt状态文件管理
- 基础服务安装和配置
- 命令行工具界面
- 日志和监控系统
- 配置文件管理

### 📦 技术特性
- 模块化设计
- Salt原生功能
- 自动化部署
- 错误处理机制
