#!/bin/bash
# SaltGoat 主入口脚本 - 混合模式设计

set -e

# 抑制 Salt DeprecationWarning 警告
export PYTHONWARNINGS="ignore::DeprecationWarning"
export PYTHONPATH="/usr/local/lib/python3.12/dist-packages:$PYTHONPATH"

# 创建临时的 Python 警告过滤器
python3 -c "
import warnings
warnings.filterwarnings('ignore', category=DeprecationWarning)
warnings.filterwarnings('ignore', message='.*datetime.datetime.utcnow.*')
warnings.filterwarnings('ignore', message='.*crypt.*')
warnings.filterwarnings('ignore', message='.*spwd.*')
" 2>/dev/null || true

# 脚本信息
SCRIPT_NAME="SaltGoat"
SCRIPT_VERSION="0.9.15"

# 获取脚本实际路径（处理符号链接）
if [[ -L "${BASH_SOURCE[0]}" ]]; then
    # 如果是符号链接，获取实际路径
    SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
else
    # 如果不是符号链接，使用常规方法
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi

# 加载公共库
source "${SCRIPT_DIR}/lib/logger.sh"
source "${SCRIPT_DIR}/lib/utils.sh"
source "${SCRIPT_DIR}/lib/help.sh"

declare -A SALTGOAT_MODULE_FILES=()
declare -A SALTGOAT_MODULE_LOADED=()

register_module() {
    local key="$1"
    local path="$2"
    SALTGOAT_MODULE_FILES["$key"]="$path"
}

require_module() {
    local key="$1"
    local file="${SALTGOAT_MODULE_FILES[$key]:-}"
    if [[ -z "$file" ]]; then
        return 0
    fi
    if [[ -n "${SALTGOAT_MODULE_LOADED[$key]:-}" ]]; then
        return 0
    fi
    # shellcheck disable=SC1090
    source "$file"
    SALTGOAT_MODULE_LOADED["$key"]=1
}

# 加载核心功能
source "${SCRIPT_DIR}/core/install.sh"
source "${SCRIPT_DIR}/core/system.sh"
source "${SCRIPT_DIR}/core/optimize.sh"

# 注册按需加载模块
register_module "nginx" "${SCRIPT_DIR}/services/nginx.sh"
register_module "rabbitmq" "${SCRIPT_DIR}/services/rabbitmq.sh"
register_module "backup" "${SCRIPT_DIR}/modules/maintenance/backup.sh"
register_module "logs" "${SCRIPT_DIR}/modules/maintenance/logs.sh"
register_module "maintenance" "${SCRIPT_DIR}/modules/maintenance/maintenance.sh"
register_module "security" "${SCRIPT_DIR}/modules/security/security.sh"
register_module "ssl" "${SCRIPT_DIR}/modules/security/ssl.sh"
register_module "performance" "${SCRIPT_DIR}/services/performance.sh"
register_module "reports" "${SCRIPT_DIR}/modules/automation/reports.sh"
register_module "automation" "${SCRIPT_DIR}/modules/automation/automation.sh"
register_module "saltgui" "${SCRIPT_DIR}/services/saltgui.sh"
register_module "optimize" "${SCRIPT_DIR}/modules/optimization/optimize.sh"
register_module "auto-tune" "${SCRIPT_DIR}/modules/optimization/auto-tune.sh"
register_module "benchmark" "${SCRIPT_DIR}/modules/optimization/benchmark.sh"
register_module "speedtest" "${SCRIPT_DIR}/modules/optimization/speedtest.sh"
register_module "monitor" "${SCRIPT_DIR}/monitoring/system.sh"
register_module "monitoring-core" "${SCRIPT_DIR}/modules/monitoring/monitor-integration.sh"
register_module "monitoring-levels" "${SCRIPT_DIR}/modules/monitoring/monitoring-levels.sh"
register_module "monitoring-smart" "${SCRIPT_DIR}/modules/monitoring/smart-monitoring.sh"
register_module "monitoring-dynamic" "${SCRIPT_DIR}/modules/monitoring/dynamic-monitoring.sh"
register_module "monitoring-cost" "${SCRIPT_DIR}/modules/monitoring/cost-optimized-monitoring.sh"
register_module "monitoring-grafana" "${SCRIPT_DIR}/modules/monitoring/grafana-email.sh"
register_module "state" "${SCRIPT_DIR}/services/state.sh"
register_module "diagnose" "${SCRIPT_DIR}/modules/diagnose/diagnose.sh"
register_module "version-lock" "${SCRIPT_DIR}/modules/version-lock/version-lock.sh"
register_module "profile" "${SCRIPT_DIR}/modules/profile/performance-analysis.sh"
register_module "magetools" "${SCRIPT_DIR}/modules/magetools/magetools.sh"
register_module "analyse" "${SCRIPT_DIR}/modules/analyse/analyse.sh"
register_module "git" "${SCRIPT_DIR}/modules/git/git.sh"
register_module "cockpit" "${SCRIPT_DIR}/modules/cockpit/cockpit.sh"
register_module "adminer" "${SCRIPT_DIR}/modules/adminer/adminer.sh"
register_module "uptime-kuma" "${SCRIPT_DIR}/modules/uptime-kuma/uptime-kuma.sh"
register_module "memory" "${SCRIPT_DIR}/monitoring/memory.sh"
register_module "schedule" "${SCRIPT_DIR}/monitoring/schedule.sh"

# 显示横幅
show_banner

# 状态和信息显示函数
show_status() {
    log_info "系统状态:"
    
    # 使用systemctl直接检查服务状态，避免Salt调用
    # 检查Nginx状态 - 支持源码编译和包管理器安装
    if systemctl is-active --quiet nginx 2>/dev/null; then
        echo "Nginx: active (systemd)"
    elif command -v nginx >/dev/null 2>&1 && pgrep -f "nginx: master process" >/dev/null 2>&1; then
        echo "Nginx: active (manual)"
    else
        echo "Nginx: inactive"
    fi
    echo "MySQL: $(systemctl is-active mysql 2>/dev/null || echo 'inactive')"
    echo "PHP-FPM: $(systemctl is-active php8.3-fpm 2>/dev/null || echo 'inactive')"
    echo "Valkey: $(systemctl is-active valkey 2>/dev/null || echo 'inactive')"
    echo "OpenSearch: $(systemctl is-active opensearch 2>/dev/null || echo 'inactive')"
    echo "RabbitMQ: $(systemctl is-active rabbitmq 2>/dev/null || echo 'inactive')"
}

show_versions() {
    log_info "版本信息:"
    echo "SaltGoat: $SCRIPT_VERSION"
    echo "Salt: $(salt-call --version | head -1)"
    if command -v nginx >/dev/null 2>&1; then
        echo "Nginx: $(nginx -v 2>&1 | head -1)"
    else
        echo "Nginx: 未安装"
    fi
    echo "MySQL: $(mysql --version)"
    echo "PHP: $(php -v | head -1)"
    echo "Valkey: $(valkey-server --version)"
    
    # OpenSearch 版本（从包管理器获取）
    if dpkg -l | grep -q "^ii.*opensearch "; then
        echo "OpenSearch: $(dpkg -l | grep "^ii.*opensearch " | awk '{print $3}')"
    fi
    
    # RabbitMQ 版本（使用 rabbitmqctl）
    if command -v rabbitmqctl >/dev/null 2>&1; then
        echo "RabbitMQ: $(rabbitmqctl version)"
    fi
    
    # Varnish 版本
    if command -v varnishd >/dev/null 2>&1; then
        echo "Varnish: $(varnishd -V 2>&1 | head -1)"
    fi
    
    # Webmin 版本
    if command -v webmin >/dev/null 2>&1; then
        echo "Webmin: $(dpkg -l | grep "^ii.*webmin " | awk '{print $3}')"
    fi
    
    # phpMyAdmin 版本
    if dpkg -l | grep -q "^ii.*phpmyadmin "; then
        echo "phpMyAdmin: $(dpkg -l | grep "^ii.*phpmyadmin " | awk '{print $3}')"
    fi
}

mask_secret() {
    local value="$1"
    if [[ -z "$value" || "$value" == "未知" ]]; then
        printf '%s' "${value:-未知}"
        return 0
    fi

    local length=${#value}
    if (( length <= 4 )); then
        printf '****'
    else
        local tail="${value: -4}"
        printf '***%s' "$tail"
    fi
}

show_passwords() {
    local reveal="${1:-0}"
    local skip_prompt="${2:-0}"

    if [[ "$reveal" == "1" && "$skip_prompt" != "1" ]]; then
        read -r -p "确认显示真实密码? (y/N): " reply
        if [[ ! "$reply" =~ ^[Yy]$ ]]; then
            log_info "已取消显示真实密码，将以掩码方式展示"
            reveal=0
        fi
    fi

    log_info "SaltGoat 密码信息:"
    local entries=()

    add_entry() {
        local service="$1"
        local account="$2"
        local password="$3"
        entries+=("${service}|${account}|${password}")
    }

    sanitize_value() {
        local raw="$1"
        raw="${raw%\"}"
        raw="${raw#\"}"
        printf '%s' "$raw"
    }

    local mysql_pass
    mysql_pass="$(sanitize_value "$(get_local_pillar_value mysql_password)")"
    add_entry "MySQL Root" "root@localhost" "${mysql_pass:-未知}"

    if sudo test -f /etc/salt/mysql_saltuser.cnf 2>/dev/null; then
        local mysql_saltuser mysql_saltpass
        mysql_saltuser=$(sudo awk -F= '/^user=/{print $2}' /etc/salt/mysql_saltuser.cnf 2>/dev/null | tail -1)
        mysql_saltpass=$(sudo awk -F= '/^password=/{print $2}' /etc/salt/mysql_saltuser.cnf 2>/dev/null | tail -1)
        mysql_saltuser="$(sanitize_value "$mysql_saltuser")"
        mysql_saltpass="$(sanitize_value "$mysql_saltpass")"
        add_entry "MySQL SaltUser" "${mysql_saltuser:-saltuser}@localhost" "${mysql_saltpass:-未知}"
    fi

    local valkey_pass
    valkey_pass="$(sudo awk '/^requirepass/{print $2}' /etc/valkey/valkey.conf 2>/dev/null | head -1)"
    add_entry "Valkey" "(default)" "${valkey_pass:-未知}"

    local rabbitmq_pass
    rabbitmq_pass="$(sanitize_value "$(get_local_pillar_value rabbitmq_password)")"
    add_entry "RabbitMQ" "(pillar default)" "${rabbitmq_pass:-未知}"

    local webmin_pass
    webmin_pass="$(sanitize_value "$(get_local_pillar_value webmin_password)")"
    add_entry "Webmin" "root" "${webmin_pass:-未知}"

    local phpmyadmin_pass
    phpmyadmin_pass="$(sanitize_value "$(get_local_pillar_value phpmyadmin_password)")"
    add_entry "phpMyAdmin" "root" "${phpmyadmin_pass:-未知}"

    local restic_pass=""
    if sudo test -f /etc/restic/restic.env 2>/dev/null; then
        restic_pass="$(sudo /bin/bash -c 'set -a; source /etc/restic/restic.env >/dev/null 2>&1; set +a; printf \"%s\" \"${RESTIC_PASSWORD:-}\"')"
        if [[ -z "$restic_pass" ]]; then
            local restic_file
            restic_file="$(sudo /bin/bash -c 'set -a; source /etc/restic/restic.env >/dev/null 2>&1; set +a; printf \"%s\" \"${RESTIC_PASSWORD_FILE:-}\"')"
            if [[ -n "$restic_file" && -f "$restic_file" ]]; then
                restic_pass="$(sudo tr -d '\n' < "$restic_file" 2>/dev/null)"
            fi
        fi
        restic_pass="$(sanitize_value "$restic_pass")"
        restic_pass="${restic_pass//$'\\n'/}"
        restic_pass="${restic_pass//\"/}"
    else
        restic_pass="$(sanitize_value "$(get_local_pillar_value restic_password)")"
    fi
    add_entry "Restic Backup" "(env)" "${restic_pass:-未知}"

    printf '%-18s %-22s %s\n' "服务" "账户" "密码"
    printf '%-18s %-22s %s\n' "------------------" "----------------------" "-------------------------"
    local entry service account password display
    for entry in "${entries[@]}"; do
        IFS='|' read -r service account password <<<"$entry"
        if [[ -z "$password" || "$password" == "未知" ]]; then
            display="未知"
        elif [[ "$reveal" == "1" ]]; then
            display="$password"
        else
            display="$(mask_secret "$password")"
        fi
        printf '%-18s %-22s %s\n' "$service" "$account" "$display"
    done

    echo ""
    if [[ -z "$mysql_pass" ]]; then
        log_warning "未在 Pillar 中找到 mysql_password，可能需要运行 'saltgoat passwords --refresh'"
    fi
    if [[ "$reveal" == "1" ]]; then
        log_warning "请妥善处理以上真实密码，避免泄露"
    else
        log_info "使用 'saltgoat passwords --show' 可在确认后显示真实密码"
    fi
}


generate_random_secret() {
    if command_exists openssl; then
        openssl rand -base64 18 | tr -d '\n'
    else
        python3 - <<'PY'
import secrets, string
alphabet = string.ascii_letters + string.digits + '!@#$%^&*'
print(''.join(secrets.choice(alphabet) for _ in range(20)))
PY
    fi
}

pillar_file_path() {
    echo "${SCRIPT_DIR}/salt/pillar/saltgoat.sls"
}

pillar_show() {
    local pillar_file
    pillar_file="$(pillar_file_path)"
    if [[ -f "$pillar_file" ]]; then
        log_highlight "当前 Pillar 配置 ($pillar_file):"
        cat "$pillar_file"
    else
        log_warning "Pillar 文件不存在: $pillar_file"
        log_info "可以使用 'saltgoat pillar init' 创建默认模板"
    fi
}

pillar_refresh() {
    log_highlight "刷新 Pillar 缓存..."
    if sudo salt-call --local saltutil.refresh_pillar >/dev/null; then
        log_success "Pillar 缓存已刷新"
    else
        log_warning "刷新 Pillar 缓存时出现警告"
    fi
}

pillar_init() {
    local pillar_file
    pillar_file="$(pillar_file_path)"

    if [[ -f "$pillar_file" ]]; then
        log_warning "Pillar 文件已存在: $pillar_file"
        read -r -p "是否覆盖现有文件? (y/N): " reply
        if [[ ! "$reply" =~ ^[Yy]$ ]]; then
            log_info "已取消 Pillar 初始化"
            return 0
        fi
    fi

    local mysql_pass valkey_pass rabbitmq_pass webmin_pass phpmyadmin_pass
    mysql_pass=$(generate_random_secret)
    valkey_pass=$(generate_random_secret)
    rabbitmq_pass=$(generate_random_secret)
    webmin_pass=$(generate_random_secret)
    phpmyadmin_pass=$(generate_random_secret)

    sudo mkdir -p "${SCRIPT_DIR}/salt/pillar"
    local tmp_file
    tmp_file=$(mktemp "${SCRIPT_DIR}/salt/pillar/.saltgoat.XXXXXX") || {
        log_error "无法创建临时 Pillar 文件"
        return 1
    }

    cat >"$tmp_file" <<EOF
mysql_password: '$mysql_pass'
valkey_password: '$valkey_pass'
rabbitmq_password: '$rabbitmq_pass'
webmin_password: '$webmin_pass'
phpmyadmin_password: '$phpmyadmin_pass'
ssl_email: 'admin@example.com'
timezone: 'America/Los_Angeles'
language: 'en_US.UTF-8'
smtp_host: ''
smtp_user: ''
smtp_password: ''
smtp_from_email: ''
smtp_from_name: 'SaltGoat Alerts'
EOF

    sudo mv "$tmp_file" "$pillar_file"
    sudo chmod 600 "$pillar_file"

    log_success "Pillar 模板已生成: $pillar_file"
    pillar_refresh
    pillar_show
}

refresh_password_states() {
    log_highlight "刷新 Pillar 并重新应用密码相关配置..."
    sudo salt-call --local saltutil.refresh_pillar >/dev/null 2>&1 || true
    sudo salt-call --local state.apply core.mysql >/dev/null 2>&1 || true
    sudo salt-call --local state.apply optional.valkey >/dev/null 2>&1 || true
    sudo salt-call --local state.apply optional.rabbitmq >/dev/null 2>&1 || true
    sudo salt-call --local state.apply optional.webmin >/dev/null 2>&1 || true
    log_success "密码相关状态已重新应用"
}


# 检查权限
check_permissions "$@"

# 主命令路由
case "$1" in
    "install")
        case "$2" in
            "all")
                install_all "${@:3}"
                ;;
            "core")
                install_core
                ;;
            "optional")
                install_optional
                ;;
            *)
                log_error "未知的安装选项: $2"
                log_info "支持: all, core, optional"
                log_info "使用 'saltgoat install all --help' 查看参数选项"
                exit 1
                ;;
        esac
        ;;
    "pillar")
        case "$2" in
            ""|"show")
                pillar_show
                ;;
            "init")
                pillar_init
                ;;
            "refresh")
                pillar_refresh
                ;;
            *)
                log_error "未知的 Pillar 操作: ${2:-<none>}"
                log_info "支持: show, init, refresh"
                exit 1
                ;;
        esac
        ;;
    "system")
        case "$2" in
            "install")
                log_highlight "安装 SaltGoat 到系统路径..."
                system_install
                ;;
            "uninstall")
                log_highlight "卸载 SaltGoat 系统安装..."
                system_uninstall
                ;;
            "ssh-port")
                log_highlight "检测当前 SSH 端口..."
                detect_ssh_port
                ;;
            *)
                log_error "未知的 System 操作: $2"
                log_info "支持: install, uninstall, ssh-port"
                exit 1
                ;;
        esac
        ;;
    "nginx")
        require_module "nginx"
        nginx_handler "$@"
        ;;
    "rabbitmq")
        require_module "rabbitmq"
        rabbitmq_handler "$@"
        ;;
    "backup")
        require_module "backup"
        case "$2" in
            "create")
                backup_create "$3"
                ;;
            "site")
                case "$3" in
                    "create")
                        backup_create_site "$4" "$5"
                        ;;
                    "restore")
                        backup_restore_site "$4" "$5" "$6"
                        ;;
                    "list")
                        backup_list_sites
                        ;;
                    *)
                        log_error "未知的站点备份操作: $3"
                        log_info "支持: create, restore, list"
                        log_info "示例: saltgoat backup site create tank tank"
                        log_info "示例: saltgoat backup site restore tank /path/to/backup.tar.gz"
                        log_info "示例: saltgoat backup site list"
                        exit 1
                        ;;
                esac
                ;;
            "list")
                backup_list
                ;;
            "restore")
                backup_restore "$3"
                ;;
            "delete")
                backup_delete "$3"
                ;;
            "cleanup")
                backup_cleanup
                ;;
            *)
                log_error "未知的备份操作: $2"
                log_info "支持: create, site, list, restore, delete, cleanup"
                log_info "站点备份: saltgoat backup site <create|restore|list> [args]"
                exit 1
                ;;
        esac
        ;;
    "logs")
        require_module "logs"
        case "$2" in
            "view")
                log_view "$3" "$4"
                ;;
            "cleanup")
                log_cleanup "$3" "$4"
                ;;
            "rotate")
                log_rotate "$3"
                ;;
            "stats")
                log_stats
                ;;
            "monitor")
                log_monitor "$3"
                ;;
            *)
                log_error "未知的日志操作: $2"
                log_info "支持: view, cleanup, rotate, stats, monitor"
                exit 1
                ;;
        esac
        ;;
    "security")
        require_module "security"
        case "$2" in
            "scan")
                security_full_scan
                ;;
            "ports")
                security_port_scan
                ;;
            "services")
                security_service_check
                ;;
            "files")
                security_file_permissions
                ;;
            "firewall")
                security_firewall_check
                ;;
            "updates")
                security_updates_check
                ;;
            "users")
                security_user_check
                ;;
            "logs")
                security_log_check
                ;;
            "report")
                security_report
                ;;
            *)
                log_error "未知的安全操作: $2"
                log_info "支持: scan, ports, services, files, firewall, updates, users, logs, report"
                exit 1
            ;;
        esac
        ;;
    "analyse")
        require_module "analyse"
        analyse_handler "${@:2}"
        ;;
    "git")
        require_module "git"
        git_handler "${@:2}"
        ;;
        "performance")
            require_module "performance"
            case "$2" in
                "cpu")
                    performance_cpu
                    ;;
                "memory")
                    performance_memory
                    ;;
                "disk")
                    performance_disk
                    ;;
                "network")
                    performance_network
                    ;;
                "processes")
                    performance_processes
                    ;;
                "load")
                    performance_load
                    ;;
                "benchmark")
                    performance_benchmark
                    ;;
                "history")
                    performance_history
                    ;;
                "report")
                    performance_report
                    ;;
                "cleanup")
                    performance_cleanup
                    ;;
                *)
                    log_error "未知的性能操作: $2"
                    log_info "支持: cpu, memory, disk, network, processes, load, benchmark, history, report, cleanup"
                    exit 1
                    ;;
            esac
            ;;
        "ssl")
            require_module "ssl"
            case "$2" in
                "generate-self-signed")
                    ssl_generate_self_signed "$3" "$4"
                    ;;
                "generate-csr")
                    ssl_generate_csr "$3" "$4" "$5" "$6" "$7"
                    ;;
                "view")
                    ssl_view_cert "$3"
                    ;;
                "verify")
                    ssl_verify_cert "$3" "$4"
                    ;;
                "list")
                    ssl_list_certs
                    ;;
                "renew")
                    ssl_renew_cert "$3" "$4"
                    ;;
                "backup")
                    ssl_backup_certs "$3"
                    ;;
                "cleanup-expired")
                    ssl_cleanup_expired "$3"
                    ;;
                "status")
                    ssl_status
                    ;;
                *)
                    log_error "未知的 SSL 操作: $2"
                    log_info "支持: generate-self-signed, generate-csr, view, verify, list, renew, backup, cleanup-expired, status"
                    exit 1
                    ;;
            esac
            ;;
        "monitor")
            require_module "monitor"
            case "$2" in
                "system")
                    monitor_system_status
                    ;;
                "services")
                    monitor_service_status
                    ;;
                "resources")
                    monitor_resource_usage
                    ;;
                "network")
                    monitor_network_status
                    ;;
                "logs")
                    monitor_log_status
                    ;;
                "security")
                    monitor_security_status
                    ;;
                "performance")
                    monitor_performance
                    ;;
                "report")
                    monitor_generate_report "$3"
                    ;;
                "realtime")
                    monitor_realtime "$3"
                    ;;
                "enable-beacons")
                    monitor_enable_events
                    ;;
                "beacons-status")
                    monitor_beacon_status
                    ;;
                "config")
                    monitor_config
                    ;;
                "cleanup")
                    monitor_cleanup "$3"
                    ;;
                *)
                    log_error "未知的监控操作: $2"
                    log_info "支持: system, services, resources, network, logs, security, performance, report, realtime, enable-beacons, beacons-status, config, cleanup"
                    exit 1
                    ;;
            esac
            ;;
    "memory")
        require_module "memory"
        memory_handler "$@"
        ;;
    "schedule")
        require_module "schedule"
        schedule_handler "$@"
        ;;
    "optimize")
        require_module "optimize"
        case "$2" in
            "magento")
                log_highlight "开始 Magento2 专用优化..."
                log_info "基于 Magento2 官方建议的完整优化方案"
                shift 2
                optimize_magento "$@"
                ;;
            *)
                # 如果没有子命令，执行智能优化建议
                log_highlight "智能优化建议分析..."
                shift || true
                optimize "$@"
                ;;
        esac
        ;;
    "auto-tune")
        require_module "auto-tune"
        auto_tune
        ;;
    "benchmark")
        require_module "benchmark"
        benchmark
        ;;
    "speedtest")
        require_module "speedtest"
        case "$2" in
            "quick")
                speedtest_quick
                ;;
            "server")
                speedtest_server "$3"
                ;;
            "list")
                speedtest_list
                ;;
            *)
                speedtest
                ;;
        esac
        ;;
    "maintenance")
        require_module "maintenance"
        maintenance_handler "$2" "$3" "$4" "$5"
        ;;
    "reports")
        require_module "reports"
        report_handler "$2" "$3" "$4" "$5"
        ;;
    "automation")
        require_module "automation"
        automation_handler "${2:-}" "${3:-}" "${4:-}" "${5:-}"
        ;;
    "saltgui")
        require_module "saltgui"
        saltgui_handler "$2" "$3" "$4" "$5"
        ;;
    "status")
        log_highlight "查看系统状态..."
        show_status
        ;;
    "versions")
        log_highlight "查看版本信息..."
        show_versions
        ;;
    "passwords")
        refresh_requested=0
        reveal_passwords=0
        skip_prompt=0

        for opt in "${@:2}"; do
            case "$opt" in
                "--refresh"|"refresh")
                    refresh_requested=1
                    ;;
                "--show"|"show")
                    reveal_passwords=1
                    ;;
                "--yes"|"--force")
                    skip_prompt=1
                    ;;
                "")
                    ;;
                *)
                    log_error "未知的 passwords 选项: $opt"
                    log_info "支持: --refresh, --show, --yes"
                    exit 1
                    ;;
            esac
        done

        if (( refresh_requested )); then
            refresh_password_states
        fi
        log_highlight "查看配置的密码..."
        show_passwords "$reveal_passwords" "$skip_prompt"
        unset refresh_requested reveal_passwords skip_prompt
        ;;
    "lint")
        log_highlight "SaltGoat 代码检查..."
        "${SCRIPT_DIR}/scripts/code-review.sh" -c "$2"
        ;;
    "format")
        log_highlight "SaltGoat 代码格式化..."
        "${SCRIPT_DIR}/scripts/code-review.sh" -f "$2"
        ;;
    "security-scan")
        log_highlight "SaltGoat 安全扫描..."
        require_module "security"
        security_full_scan
        ;;
    "state")
        require_module "state"
        case "$2" in
            "list")
                log_highlight "SaltGoat 状态列表..."
                state_list
                ;;
            "apply")
                log_highlight "SaltGoat 应用状态..."
                state_apply "$3"
                ;;
            "rollback")
                log_highlight "SaltGoat 状态回滚..."
                state_rollback "$3"
                ;;
            *)
                log_error "用法: saltgoat state <list|apply|rollback> [state_name]"
                log_info "示例:"
                log_info "  saltgoat state list                    # 列出所有状态"
                log_info "  saltgoat state apply nginx             # 应用nginx状态"
                log_info "  saltgoat state rollback nginx          # 回滚nginx状态"
                exit 1
                ;;
        esac
        ;;
    "diagnose")
        require_module "diagnose"
        if [[ -z "$2" ]]; then
            log_error "用法: saltgoat diagnose <type>"
            log_info "支持的类型:"
            log_info "  nginx     - 诊断Nginx服务"
            log_info "  mysql     - 诊断MySQL服务"
            log_info "  php       - 诊断PHP服务"
            log_info "  system    - 诊断系统状态"
            log_info "  network   - 诊断网络连接"
            log_info "  all       - 完整系统诊断"
            log_info ""
            log_info "示例:"
            log_info "  saltgoat diagnose nginx"
            log_info "  saltgoat diagnose all"
            exit 1
        fi
        
        diagnose_handler "$2"
        ;;
    "version-lock")
        require_module "version-lock"
        if [[ -z "$2" ]]; then
            log_error "用法: saltgoat version-lock <command>"
            log_info "支持的命令:"
            log_info "  lock    - 锁定主要软件版本"
            log_info "  unlock  - 解锁软件版本"
            log_info "  show    - 显示锁定的软件包"
            log_info "  status  - 检查软件版本状态"
            log_info "  help    - 显示帮助信息"
            exit 1
        fi
        
        version_lock_handler "$2"
        ;;
    "profile")
        require_module "profile"
        if [[ -z "$2" ]]; then
            log_error "用法: saltgoat profile <command>"
            log_info "支持的命令:"
            log_info "  analyze <type> - 性能分析"
            log_info "    支持的类型: system, nginx, mysql, php, memory, disk, network, all"
            log_info "  help          - 显示帮助信息"
            log_info ""
            log_info "示例:"
            log_info "  saltgoat profile analyze system"
            log_info "  saltgoat profile analyze all"
            exit 1
        fi
        
        case "$2" in
            "analyze")
                if [[ -z "$3" ]]; then
                    log_error "用法: saltgoat profile analyze <type>"
                    log_info "支持的类型: system, nginx, mysql, php, memory, disk, network, all"
                    exit 1
                fi
                performance_analyze_handler "$3"
                ;;
            "help"|"--help"|"-h")
                log_info "性能分析功能帮助:"
                log_info "用法: saltgoat profile <command>"
                log_info ""
                log_info "命令:"
                log_info "  analyze <type> - 性能分析"
                log_info "    支持的类型:"
                log_info "      system   - 系统性能分析"
                log_info "      nginx    - Nginx性能分析"
                log_info "      mysql    - MySQL性能分析"
                log_info "      php      - PHP性能分析"
                log_info "      memory   - 内存性能分析"
                log_info "      disk     - 磁盘性能分析"
                log_info "      network  - 网络性能分析"
                log_info "      all      - 完整性能分析"
                log_info ""
                log_info "示例:"
                log_info "  saltgoat profile analyze system"
                log_info "  saltgoat profile analyze all"
                ;;
            *)
                log_error "未知的性能分析命令: $2"
                log_info "使用 'saltgoat profile help' 查看帮助"
                return 1
                ;;
        esac
        ;;
    "monitoring")
        require_module "monitoring-core"
        require_module "monitoring-levels"
        require_module "monitoring-smart"
        require_module "monitoring-dynamic"
        require_module "monitoring-cost"
        require_module "monitoring-grafana"
        case "$2" in
            "prometheus")
                if [[ -n "$3" ]]; then
                    case "$3" in
                        "low"|"medium"|"high"|"auto")
                            log_highlight "SaltGoat 分级监控配置..."
                            install_monitoring_by_level "$3"
                            ;;
                        *)
                            log_error "未知的监控级别: $3"
                            log_info "支持的级别: low, medium, high, auto"
                            exit 1
                            ;;
                    esac
                else
                    log_highlight "SaltGoat Prometheus集成..."
                    monitor_prometheus_setup
                fi
                ;;
           "grafana")
               case "$3" in
                   "email")
                       log_highlight "SaltGoat Grafana邮件配置..."
                       configure_grafana_email "$4" "$5" "$6" "$7" "$8"
                       ;;
                   "test-email")
                       log_highlight "SaltGoat 测试邮件发送..."
                       test_email_sending "$4"
                       ;;
                   "email-help")
                       show_email_config_help
                       ;;
                   *)
                       log_highlight "SaltGoat Grafana集成..."
                       monitor_grafana_setup
                       ;;
               esac
               ;;
            "smart")
                log_highlight "SaltGoat 智能监控配置..."
                install_smart_monitoring
                ;;
            "dynamic")
                log_highlight "SaltGoat 动态监控配置..."
                install_dynamic_monitoring
                ;;
            "cost")
                log_highlight "SaltGoat 成本优化监控配置..."
                install_cost_optimized_monitoring
                ;;
            "levels")
                show_monitoring_levels_help
                ;;
            "help")
                show_monitoring_help
                ;;
            *)
                log_error "用法: saltgoat monitoring <command> [options]"
                log_info "命令:"
                log_info "  prometheus [level]    - 安装Prometheus (支持low/medium/high/auto)"
                log_info "  grafana              - 安装Grafana"
                log_info "  grafana email        - 配置Grafana邮件通知"
                log_info "  grafana test-email   - 测试邮件发送"
                log_info "  grafana email-help   - 邮件配置帮助"
                log_info "  smart                - 智能业务场景监控"
                log_info "  dynamic              - 动态负载监控"
                log_info "  cost                 - 成本优化监控"
                log_info "  levels               - 查看分级监控帮助"
                log_info "  help                 - 查看监控帮助"
                log_info ""
                log_info "示例:"
                log_info "  saltgoat monitoring prometheus high      # 高级别监控"
                log_info "  saltgoat monitoring smart                # 智能监控"
                log_info "  saltgoat monitoring dynamic              # 动态监控"
                log_info "  saltgoat monitoring cost                # 成本优化监控"
                exit 1
                ;;
        esac
        ;;
    "magetools")
        require_module "magetools"
        magetools_handler "${@:2}"
        ;;
    "cockpit")
        require_module "cockpit"
        cockpit_main "$2" "$3" "$4"
        ;;
    "adminer")
        require_module "adminer"
        adminer_main "$2" "$3" "$4"
        ;;
    "uptime-kuma")
        require_module "uptime-kuma"
        uptime_kuma_main "$2" "$3" "$4"
        ;;
    "help"|"--help"|"-h"|"")
        show_help "$2"
        ;;
    *)
        log_error "未知命令: $1"
        show_help
        exit 1
        ;;
esac
