#jinja2: lstrip_blocks: True, trim_blocks: True
{% set defaults = {
  'base_dir': '/opt/saltgoat/docker/traefik',
  'image': 'traefik:v3.1',
  'project': 'traefik',
  'http_port': 18080,
  'https_port': 0,
  'dashboard_port': 19080,
  'log_level': 'INFO',
  'extra_args': [],
  'environment': {},
  'dashboard': {
    'enabled': True,
    'insecure': False,
    'basic_auth': {}
  },
  'acme': {
    'enabled': False,
    'resolver': 'saltgoat',
    'email': '',
    'storage': 'acme.json',
    'http_challenge': {
      'enabled': True,
      'entrypoint': 'web'
    },
    'tls_challenge': False
  }
} %}
{% set cfg = salt['slsutil.merge'](defaults, salt['pillar.get']('docker:traefik', {}) or {}, strategy='recurse') %}
services:
  traefik:
    image: {{ cfg.get('image', 'traefik:v3.1') }}
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
{% if cfg.get('https_port') %}
      - "--entrypoints.websecure.address=:443"
{% endif %}
      - "--log.level={{ cfg.get('log_level', 'INFO') | lower }}"
{% if cfg.get('dashboard', {}).get('enabled', True) %}
      - "--api.dashboard=true"
{% else %}
      - "--api.dashboard=false"
{% endif %}
{% if cfg.get('dashboard', {}).get('insecure', False) %}
      - "--api.insecure=true"
{% else %}
      - "--api.insecure=false"
{% endif %}
{% set acme = cfg.get('acme', {}) %}
{% if acme.get('enabled') %}
      - "--certificatesresolvers.{{ acme.get('resolver', 'saltgoat') }}.acme.email={{ acme.get('email', '') }}"
      - "--certificatesresolvers.{{ acme.get('resolver', 'saltgoat') }}.acme.storage=/var/lib/traefik/{{ acme.get('storage', 'acme.json') }}"
{% if acme.get('http_challenge', {}).get('enabled', True) %}
      - "--certificatesresolvers.{{ acme.get('resolver', 'saltgoat') }}.acme.httpchallenge=true"
      - "--certificatesresolvers.{{ acme.get('resolver', 'saltgoat') }}.acme.httpchallenge.entrypoint={{ acme.get('http_challenge', {}).get('entrypoint', 'web') }}"
{% endif %}
{% if acme.get('tls_challenge') %}
      - "--certificatesresolvers.{{ acme.get('resolver', 'saltgoat') }}.acme.tlschallenge=true"
{% endif %}
{% endif %}
{% for arg in cfg.get('extra_args', []) %}
      - "{{ arg }}"
{% endfor %}
    ports:
      - "{{ cfg.get('http_port', 18080) }}:80"
{% if cfg.get('https_port') %}
      - "{{ cfg.get('https_port') }}:443"
{% endif %}
{% if cfg.get('dashboard_port') %}
      - "{{ cfg.get('dashboard_port') }}:8080"
{% endif %}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - {{ cfg.get('base_dir', '/opt/saltgoat/docker/traefik') }}/config/traefik.yml:/etc/traefik/traefik.yml:ro
      - {{ cfg.get('base_dir', '/opt/saltgoat/docker/traefik') }}/dynamic:/etc/traefik/dynamic:ro
      - {{ cfg.get('base_dir', '/opt/saltgoat/docker/traefik') }}/data:/var/lib/traefik
{% set env_map = cfg.get('environment', {}) %}
{% if env_map %}
    environment:
{%   for key, value in env_map.items() %}
      {{ key }}: {{ value }}
{%   endfor %}
{% else %}
    environment: {}
{% endif %}
    networks:
      - saltgoat-core

networks:
  saltgoat-core:
    external: true
