{#-
  Render Telegram configuration for reactor helpers.
-#}
{% set raw_entries = salt['pillar.get']('saltgoat:beacons:telegram_bot_msg', []) %}
{% set ns = namespace(current={}, records=[]) %}
{% for entry in raw_entries if entry is mapping %}
  {% if entry.get('token') and ns.current %}
    {% do ns.records.append(ns.current) %}
    {% set ns.current = {} %}
  {% endif %}
  {% do ns.current.update(entry) %}
{% endfor %}
{% if ns.current %}
  {% do ns.records.append(ns.current) %}
{% endif %}
{% set normalized = [] %}
{% for record in ns.records %}
  {% set token = record.get('token') %}
  {% if not token %}
    {% continue %}
  {% endif %}
  {% set collected_targets = [] %}
  {% set accept_val = record.get('accept_from') %}
  {% if accept_val %}
    {% if accept_val is sequence and accept_val is not string %}
      {% for chat in accept_val %}
        {% if chat not in collected_targets %}
          {% do collected_targets.append(chat) %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% if accept_val not in collected_targets %}
        {% do collected_targets.append(accept_val) %}
      {% endif %}
    {% endif %}
  {% endif %}
  {% if record.get('chat_id') and record.get('chat_id') not in collected_targets %}
    {% do collected_targets.append(record.get('chat_id')) %}
  {% endif %}
  {% set extra_targets = record.get('targets') %}
  {% if extra_targets %}
    {% if extra_targets is sequence and extra_targets is not string %}
      {% for chat in extra_targets %}
        {% if chat not in collected_targets %}
          {% do collected_targets.append(chat) %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% if extra_targets not in collected_targets %}
        {% do collected_targets.append(extra_targets) %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% set targets = [] %}
  {% for target in collected_targets %}
    {% if target is mapping %}
      {% set chat_id = target.get('chat_id') or target.get('id') or target.get('chat') %}
      {% if chat_id in (None, '') %}
        {% continue %}
      {% endif %}
      {% set normalized_target = {'chat_id': chat_id} %}
      {% set thread_id = target.get('thread_id') or target.get('thread') %}
      {% if thread_id not in (None, '', 0, '0') %}
        {% do normalized_target.update({'thread_id': thread_id}) %}
      {% endif %}
      {% if normalized_target not in targets %}
        {% do targets.append(normalized_target) %}
      {% endif %}
    {% else %}
      {% if target not in (None, '') %}
        {% set normalized_target = {'chat_id': target} %}
        {% if normalized_target not in targets %}
          {% do targets.append(normalized_target) %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if not targets %}
    {% continue %}
  {% endif %}

  {% set topics = {} %}
  {% if record.get('topics') is mapping %}
    {% for topic_key, topic_value in record.get('topics').items() %}
      {% if topic_key in (None, '') or topic_value in (None, '', 0, '0') %}
        {% continue %}
      {% endif %}
      {% do topics.update({(topic_key|string): topic_value}) %}
    {% endfor %}
  {% endif %}

  {% set normalized_entry = {
    "name": record.get('name') or 'profile_' ~ loop.index,
    "enabled": record.get('enabled', True),
    "token": token,
    "targets": targets,
    "topics": topics,
    "interval": record.get('interval')
  } %}
  {% do normalized.append(normalized_entry) %}
{% endfor %}
{% set payload = {
  "entries": normalized,
  "generated_on": salt['grains.get']('host', ''),
  "generated_at": salt['grains.get']('datetime', {}).get('iso8601', '')
} %}
{{ payload | json }}
