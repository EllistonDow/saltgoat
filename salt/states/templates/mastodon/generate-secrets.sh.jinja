#!/bin/bash
# Generate Mastodon secrets if the target file does not yet exist.
set -euo pipefail

TARGET="{{ secrets_path }}"

if [[ -f "$TARGET" ]]; then
    exit 0
fi

if ! command -v openssl >/dev/null 2>&1; then
    echo "openssl not available; cannot generate Mastodon secrets" >&2
    exit 1
fi

umask 077
cat <<'EOF' >"$TARGET"
SECRET_KEY_BASE=$(openssl rand -hex 64)
OTP_SECRET=$(openssl rand -hex 64)
VAPID_PRIVATE_KEY=$(openssl rand -hex 32)
VAPID_PUBLIC_KEY=$(openssl rand -hex 32)
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$(openssl rand -base64 32)
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$(openssl rand -base64 32)
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$(openssl rand -base64 32)
EOF
